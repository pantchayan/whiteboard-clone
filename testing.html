<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" media="all" href="css/reset.css" />
    <!-- reset css -->
    <script
      type="text/javascript"
      src="http://code.jquery.com/jquery.min.js"
    ></script>
    <!--[if lt IE 9
      ]><script type="text/javascript" src="../excanvas.js"></script
    ><![endif]-->

    <style>
      body {
        background-color: ivory;
      }
      canvas {
        border: 1px solid red;
      }
    </style>

    <script>
      $(function () {
        var canvas = document.getElementById("canvas");
        canvas.height = 600;
        canvas.width = 800;
        var ctx = canvas.getContext("2d");
        var lastX;
        var lastY;
        var mouseX;
        var mouseY;
        var canvasOffset = $("#canvas").offset();
        var offsetX = canvasOffset.left;
        var offsetY = canvasOffset.top;
        var isMouseDown = false;
        var brushSize = 20;
        var brushColor = "#ff0000";
        var points = [];

        function handleMouseDown(e) {
          mouseX = parseInt(e.clientX - offsetX);
          mouseY = parseInt(e.clientY - offsetY);

          // Put your mousedown stuff here
          ctx.beginPath();
          if (ctx.lineWidth != brushSize) {
            ctx.lineWidth = brushSize;
          }
          if (ctx.strokeStyle != brushColor) {
            ctx.strokeStyle = brushColor;
          }
          ctx.moveTo(mouseX, mouseY);
          points.push({
            x: mouseX,
            y: mouseY,
            size: brushSize,
            color: brushColor,
            mode: "begin",
          });
          lastX = mouseX;
          lastY = mouseY;
          isMouseDown = true;
        }

        function handleMouseMove(e) {
          mouseX = parseInt(e.clientX - offsetX);
          mouseY = parseInt(e.clientY - offsetY);

          // Put your mousemove stuff here
          if (isMouseDown) {
            console.log("Mouse move");
            ctx.lineTo(mouseX, mouseY);
            ctx.stroke();
            lastX = mouseX;
            lastY = mouseY;
            // command pattern stuff
            points.push({
              x: mouseX,
              y: mouseY,
              size: brushSize,
              color: brushColor,
              mode: "draw",
            });
          }
        }
        function handleMouseUp(e) {
          mouseX = parseInt(e.clientX - offsetX);
          mouseY = parseInt(e.clientY - offsetY);

          // Put your mouseup stuff here
          isMouseDown = false;
          points.push({
            x: mouseX,
            y: mouseY,
            size: brushSize,
            color: brushColor,
            mode: "end",
          });
        }

        function redrawAll() {
          if (points.length == 0) {
            return;
          }

          ctx.clearRect(0, 0, canvas.width, canvas.height);
          console.log();
          
  console.log(ctx.strokeStyle);
          for (var i = 0; i < points.length; i++) {
            var pt = points[i];

            var begin = false;
            if (ctx.lineWidth != pt.size) {
              ctx.lineWidth = pt.size;
              begin = true;
            }
            if (ctx.strokeStyle != pt.color) {
              ctx.strokeStyle = pt.color;
              begin = true;
            }
            if (pt.mode == "begin" || begin) {
              console.log("In Begin");
              ctx.beginPath();
              ctx.moveTo(pt.x, pt.y);
            }
            console.log(pt.color, pt.x, pt.y);
            ctx.lineTo(pt.x, pt.y);
            if (pt.mode == "end" || i == points.length - 1) {
              console.log("In stroke");
              ctx.stroke();
            }
          }
          ctx.stroke();
        }

        function undoLast() {
          console.log(points.length);
          points.pop();
          console.log(points.length);
          redrawAll();
        }

        ctx.lineJoin = "round";
        ctx.fillStyle = brushColor;
        ctx.lineWidth = brushSize;

        $("#brush5").click(function () {
          brushSize = 5;
        });
        $("#brush10").click(function () {
          brushSize = 10;
        });
        // Important!  Brush colors must be defined in 6-digit hex format only
        $("#brushRed").click(function () {
          brushColor = "#ff0000";
        });
        $("#brushBlue").click(function () {
          brushColor = "#0000ff";
        });

        $("#canvas").mousedown(function (e) {
          console.log("Mouse down");
          handleMouseDown(e);
        });
        $("#canvas").mousemove(function (e) {
          
          handleMouseMove(e);
        });
        $("#canvas").mouseup(function (e) {
          console.log("Mouse up");
          handleMouseUp(e);
        });

        // hold down the undo button to erase the last line segment
        $("#undo").click(function () {
          if (points.length < 3) {
            return;
          }
          let k = points.length - 1;

          console.log(points[k].mode, 1);
          while (k >= 0 && points[k].mode != "draw") {
            console.log("while loop");
            undoLast();
            k--;
          }

          for (let i = k; i >= 0; i--) {
            if (points[i].mode != "draw") {
              console.log(points[i].mode, 2);
              break;
            }
            undoLast();
          }
        });
      }); // end $(function(){});
    </script>
  </head>

  <body>
    <p>Drag to draw. Use buttons to change lineWidth/color</p>
    <canvas id="canvas" width="300" height="300"></canvas><br />
    <button id="undo">Hold this button down to Undo</button><br /><br />
    <button id="brush5">5px Brush</button>
    <button id="brush10">10px Brush</button>
    <button id="brushRed">Red Brush</button>
    <button id="brushBlue">Blue Brush</button>
  </body>
</html>
